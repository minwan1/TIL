# Spring Boot Rabbit MQ - 1 : Rabbit MQ 설치


# 메시징 시스템의 필요성
* **특정 시스템에 의존적이지 않아도 된다.(느슨하게 결합된 시스템을 구성가능함.)**

예를들어서 우리가 회원가입기능을 구현하는데 있어 회원가입이 완료 됐을 때 메일을 전송해야한다고 가정해보겠습니다. 그런데 회원가입을 하던중 메일 서버가 네트워크 문제가 발생하면 애플레케이션 장애로 이루어집니다. 하지만 이러한 문제를 메시징 시스템을 이용하면 문제를 해결 할 수 있습니다.

* **어떠한 작업의 흐름을 비동기적으로 처리할 수 있다.**

예를들어 유저가 주문했던 음식을에 거래를 취소했다고 가정해보겠습니다. 그렇게되면 결제 파트너에의해 환불 처리가 되어야합니다. 하지만 결제파트너가 늦은 응답을 보인다면 우리의 애플리케이션 문제가 아니더라도 우리의 애플리케이션이 늦어보이는 느낌을 줄 수 있습니다. 이러한 문제를 해결해주는것이 메시징시스템입니다.

* **로그등을 특정 작업공간으로 쉽게 모을 수 있다.**

예를들어 2개의 서버를 운영하는데 어떠한 유저가 에러를 만났고 그것을 개발팀에 문의를 했습니다. 그렇다면 개발팀의 어떤 서버에서 에러가 발생한줄 모르기 떄문에 두개의 서버를 모두 확인해야할것입니다. 하지만 이로그를 특정서버에 모았다면 그 서버공간만 확인하면 될 문제입니다. 마찬가지로 이러한 문제도 메시징 시스템을 통해서 해결할 수 있습니다.

* **발행자는 소비자의, 소비자는 발행자의 위치가 어디인지 혹은 어떤 기술을 사용하는지 알지 못해도된다.**



### 단점
어떤 일들이 연달아 발생할경우 절차적 프로그래밍 모델을 따를 수 없다는 것이다. 메시징 시스템에서는 시간의 흐름에 따라 특정 상황이 발생하므로 시스템이 이를 처리할수 있도록 프로그래밍되어야한다.

## AMQP
진일보한 메시징 큐 프로토콜(AMQP, Advanced Message Queuing Protocol)은 시스템간 메시지 교환하기 위해 공개 표준으로 정의한 프로토콜이다. AQP는 발행자와 소비자 브로커사이에 발생하는 상호작용 방식 뿐만아니라 메시지와 명령어 교환형태 또한 정의하고 있다.

이전에도 상용화된 MQ제품들이 많았지만, 한가지 문제가 있었다면 그 해당 플랫폼에 종속적이였다. 하지만  AMQP의 목적은 서로 다른 시스템간에 (비용/기술/시간적인 측면에서) 최대한 효율적인 방법으로 메시지를 교환하기 위한 MQ 프로토콜인 것이다.

다음은 AMP 명세서의 개념이다.
![](https://i.imgur.com/ughjf5J.png)

AMQP를 사용 하기위해서는 아래의 개념을 알아야한다.
### AMQP 핵심 개념
**브로커**
메시지를 받거나 보내는 역할을 한다.
**연결(Connection)**
발행자와 소비자, 브로커사이의 물리적인 네트워크(TCP)연결로, 클라이언트 단절이나 네트워크 또는 브로커가 장애가 발생했을 때에만 닫힌다.

**채널**
발행자와 소비자, 브로커 사이의 논리적인 연결로, 하나의 연결 내에 다수의 채널을 설정할 수 있다. 

**익스체인지**
발행한 모든 메시지가 처음 도달하는 지점으로 메시지가 도달할 수 있도록 라우팅 규칙 적용을 담당한다. 아래와같은 라우팅 규칙이 있다
* 기본 타입
* 다이렉트(포인트 투 포인트)
* 토픽(발행 - 구독)
* 팬아웃(멀티 캐스트)
* 헤더 익스체인지

**큐**
일반적으로 알고있는 큐이다. 메모리나 디스크에 메시지를 저장하고, 그것을 consumer에게 전달하는 역할을 한다. 큐는 스스로가 관심있는 메시지 타입을 지정한 Binding을 통해 exchange에 말그대로 bind된다. 
**결합**
exchange와 큐와의 관계를 정의한 일종의 라우팅 테이블이다. 같은 큐가 여러개의 exchange에 bind 될 수도 있고, 하나의 exchange에 여러개의 큐가 binding 될 수도 있다. 

# Rabbit MQ
메시징 중개기의 우열은 탄탄함과 확정성을 기준으로 저울질할 수 있지만, 무엇보다 얼마나 빨리 작동하는지가 관건입니다. 가장 쓰기 편하고 확장성 좋은것은 단연 래빗 MQ이다. 래빗 MQ는 AMQP프로토콜을 구현한 메시지큐이다.


![Untitled Diagram](/assets/Untitled%20Diagram.jpg)


# Rabbit MQ/AMQP : 익스체인지

* **Routing Key**
  Publisher에서 송신한 메시지 헤더에 포함되는 것으로 일종의 가상 주소라고 보면 된다. Exchange는 이것을 이용해서 어떤 큐로 메시지를 라우팅할지 결정할 수 있다. (이것을 사용하지 않고 다른 룰을 이용할 수도 있음) AMQP의 표준 exchange type은 이 라우팅 키를 이용하도록 되어있다.

* **Standard Exchange Type**
  대부분의 MQ에서 가능한 여러가지 상황에 대하여 AMQP에서 정의한 표준 라우팅 알고리즘이다. 아래 별도 항목을 참고.


#  AMPQ프로토콜의 익스체인지 타입

AMPQ프로토콜의 익스체인지 타입은 **기본, 직접, 팬아웃, 토픽, 헤더**등 다섯가지가 있습니다.

![AMQP익스체인지:바인딩:큐](/assets/AMQP익스체인지:바인딩:큐.png)

**핵심은 라우팅 키와 함께 메시지를 익스체인지로 보내면 익스체인지 타입별로 메시지를 큐로 보낸다는것이다. (라우팅키가 맞지않으면 배달하지 않는다)**


| 컴포넌트      | 설명                                                      |
| --------- | ------------------------------------------------------- |
| 기본익스체인지   | 발행자로부터 수신한 메시지를 큐 또는 다른 익스체인지로 보내는 라우터 역할을 한다.          |
| 직접 익스체인지  | 라우팅 키와 큐를 1대1 바인딩합니다.                                   |
| 토픽 익스체인지  | 토픽 익스체인지는 직접 익스체인지와 비슷하나, 라우팅 키에 와일드카드를 추가해서 바인딩할 수 있다. |
| 헤더 익스체인지  | 헤더 익스체인지는 메시지 헤더에 따라 바인딩하는 기능을 더했습니다.                   |
| 팬아웃 익스체인지 | 팬아웃 익스체인지는 메시지를 바인당한 큐 전체에 복사한다. 말하자면 메시지를 방송하는셈이다.   |


