# 분산 트랜잭션


하나의 데이터베이스 인스턴스 내에서 한 트랜잭션으로 묶인 SQL 문장이 모두 커밋되거나 롤백되듯이 네트워크로 연결된 여러 개의 데이터베이스 인스턴스가 참여하는 트랜잭션에서도 각각 다른 데이터베이스 인스턴스에서 수행한 SQL 문장이 모두 동시에 커밋되거나 롤백될 수 있는 방법이 필요하다.

이렇게 여러 개의 노드 또는 다른 종류의 데이터베이스가 참여하는 하나의 트랜잭션을 분산 트랜잭션(Distributed Transaction)이라고 한다. Tibero에서는 분산 트랜잭션을 처리하기 위해 XA와 데이터베이스 링크(DBLink)를 통해 지원한다.


Tibero는 X/Open DTP(Distributed Transaction Processing) 규약의 XA를 지원한다. XA는 2PC(Two-phase commit)를 이용하여 분산 트랜잭션을 처리한다.


## Two-phase commit mechanism
Two-phase commit mechanism은 분산 컴퓨팅 환경에서 트랜잭션에 참여하는 모든 데이터베이스가 정상적으로 수정되었음을 보장하는 두 단계 커밋 프로토콜이다. 분산 트랜잭션에 참여한 모든 데이터베이스가 모두 함께 커밋되거나 롤백되는 것을 보장한다.

Two-phase commit mechanism은 다음과 같이 두 단계로 작업이 이루어진다.

### First Phase(또는 Prepare Phase)

* First Phase는 각 데이터베이스 노드에 커밋을 하기 위한 준비 요청 단계이다.

* 다음은 First Phase가 실행되는 과정이다.

    1. TM은 각 데이터베이스 노드에 커밋을 준비하라는 prepare 메시지를 보낸다.

    2. 요청을 받은 각 데이터베이스는 커밋을 준비한다.

    커밋을 하기 위한 준비 작업에는 필요한 리소스에 잠금(Lock)을 설정하거나 로그 파일을 저장하는 작업 등이 있다.

    3. 각 데이터베이스는 커밋 준비 여부에 따라 TM에 성공 또는 실패 여부를 알린다.
      커밋 준비가 모두 끝나면 prepare가 성공한 것이고, 커밋 준비를 실패하면 prepare가 실패한 것이다.

### Second Phase(또는 Commit Phase)

TM은 참여한 모든 데이터베이스 노드로부터 prepare의 완료 메시지를 받을 때까지 대기한다. 이 단계에서는 전달 받은 prepare의 메시지에 따라 해당 결과가 다르다.

구분 | 설명
------- | -------
롤백 | 한 데이터베이스 노드라도 prepare ok 메시지를 받지 않으면 이 트랜잭션은 커밋할 수 없다고 판단하고, 모든 데이터베이스 노드에 롤백 메시지를 보내 해당 작업을 롤백한다.
커밋 | 모든 데이터베이스 노드로부터 prepare ok 메시지를 받으면 다시 모든 데이터베이스 노드에 커밋 메시지를 보내고 모든 작업을 커밋한다.