# 웹브라우저가 메시지를 찾는다.

## 웹브라우저가 HTTP request 메시지를 작성한다
브라우저가 처음 하는 일은 웹서버에 보내는 리퀘스트의 메시지를 작성하기위해 이 URL을 해독하는것이다. 웹 서버는 URL을 기반으로 '무엇을', '어떻게'하는지판단한 후 요구에 따라 동작하고, 결과 데이터를 응답 메시지에 저장한다. 그리고 결과가 정상인지를 헤더와 바디에 정보를 담아 리턴해준다. 그리고 그결과값을 클라이언트에 도착하여 브라우저가 메시지 안에 데이터를 추출하여 화면에 표시하게 된다. 

## 웹서버의 IP 주소를 DNS서버에 조회한다.
HTTP 메시지를 만들면 OS에 의뢰해서 웹서버에 송신합니다. **메시지를 네트워크에 송출하는 기능은 없으므로 OS에 의뢰하여 송신하는것이다.** 여기에서 브라우저는 IP주소를 조사해 운영체제에게 넘겨야한다. **OS에 송신을 의뢰할 때는 도메인명이 아니라 IP주소로 메시지를 받을 상대를 지정해줘야하기 떄문이다.**

IP주소는 전화번호와 같기떄문에 만약 IP주소를 모른다면 OS는 통신을 할 수 없습니다.  하지만 유저들이 IP주소를 외우고 다니기는 힘들기 때문에 DNS서버를 이용해 문자열로 주소를 관리할 수 있다. 예를들어 www.naver.com으로 DNS서버에 요청을 하게되면 해당 IP를 알 수 있다. 여기에서 클라이언트가 IP주소를 알아내는 방법은 다음과 같다.
1. 사용자 프로그램이 시스템콜을 발생시켜 도메인명을 운영체제에게 알려준다.
2. 운영체제는 소켓라이브러리에 **네임 리졸버**라는 모듈을 통해 DNS서버에 호출 메시지를 만든다.
3. 이것을 운영체제에 프로토콜 스택영역을 호출하여 DNS서버를 호출을 의뢰하여 IP주소를 알아낸다. 

> Socket 라이브러리는 네트워크 기능을 호출하기 위한 프로그램의 부품입니다.

> 프로토콜 스택은 OS 내부에 내장된 네트워크 제엉용 소프트웨어

소스로 보면 다음과 같습니다
```c
메모리 영역 = gethostbyname("www.naver.com"); // 메모리영역에 IP할당
//gethostbyname 는 리졸버의 프로그램명
```

사용자프로그램은 위와 같이 IP를 알아내 운영체제에게 HTTP 메시지 송신을 부탁한다. 그림으로 표현하면 다음과 같다.
![](https://i.imgur.com/WzaOkmf.png)

## 프로토콜 스택에 메시지를 송신을 의뢰한다.

### 데이터 송수신
DNS 서버를 통해 IP주소를 알았으면 이제 OS를 통해 대상 웹서버에 메시지를 송신하도록 합니다.
> 운영체제 내부의 프로토콜 스택에 메시지 송신 동작을 의뢰할 때는 Socket 라이브러리 프로그램 부품을 결정된 순번대로 호출합니다.

대략 데이터 송수신하는것을 그림으로 표현하면 아래와 같다.
![](https://i.imgur.com/1ew89UP.png)

데이터를 송, 수신 하기위해서는 데이터의 통로 같은것이 있다. 데이터는 어느쪽에서 쏟아 부어도 상관없고 양방향으로 데이터를 보낼 수 있다. 위에 그림은 데이터 파이프가 셋팅이 되어있지만 실제 저 파이프라인을 연결하기위해서는 다음과 같은 동작을 해야한다.

1. 소켓을 생성한다.
2. 서버측의 소켓에 파이프를 연결한다.
3. 데이터를 송수신한다.
4. 파이프를 분리하고 소켓을 말소한다.

> 연결끊기는 클라이언트측 서버측에서 해도 상관이없다. HTTP 1.0 같은경우 서버측에서먼저 연결을 끊기도 한다.

이 네가지 동작을 실행하는것은 OS 내부의 프로토콜 스택이다. 여기에서 소켓라이브러리는 프로그램은 사용자프로그램에 의해 호출되어 실행되지만 실제로는 프로토콜 스택과 중개 역할을 한다.

### 소켓의 작성단계
먼저 소켓을 만들고 데이터를 송신하는 과정을 코드로 풀면 다음과 같습니다.

```c
1. ip = gethostbyname("www.naver.com"); // 10진수 ip를 얻어낸다.
2. socket = socket(ip, port);
3. connect(scoket, ip, port);
4. write(socket, 송신데이터, 송신데이터 길이);
5. receiveData = read(socket,...);
...
```

위 소스를 설명하면 다음과 같다.
1. DNS를 통해 실제 IP주소를 알아냅니다.
2. 소켓 데이터를 생성하고 소켓을 변수에 저장합니다.
3. 만든 소켓을 서버측의 소켓에 접속하도록 프로토콜 스택에 의뢰합니다.
    * IP/PORT : 클라이언트와 서버간에 상대의 소켓을 식별하는것
4. 소켓이 상대측과 연결되면 다음은 소켓에서 데이터를 쏟아부으면 상대측의 소켓에 데이터가 도착합니다.
5. 만약 수신할 데이터가 있다면 read라는 시스템콜을 통해 데이터를 수신할 수 있다.
6. 클라이언트(브라우저)가 데이터 수신을 완료하면 송,수신 동작은 끝난다.(소켓 종료)

이것이 HTTP의 동작이다. HTTP 프로토콜은 HTML문서나 영상 데이터를 하나하나 별도의 것으로 취급하여 1개의 데이터를 읽을 때 마다  접속, 리퀘스트 메시지 송신, 응답메시지 수신, 연결끊기라는 동작을 반복합니다.

따라서 하나의 웹페이지에 영상이 많이 포함되어있으면 접속, 송수신, 연결끊기 동작을 여러번 하게 됩니다. 하지만 이러한 비효율적인 방법으로인해 HTTP 1.1버전에서 연결을 유지하는 방법을 사용할 수 있도록 했습니다. 이경우 리퀘스트해야할 데이터가 없어진 상태에서 브라우저로 연결끊기를 할 수 있게 되었다.




