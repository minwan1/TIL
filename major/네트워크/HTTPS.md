
# HTTPS란

<!-- TOC -->

- [HTTPS란](#https란)
    - [HTTP란](#http란)
    - [HTTPS란](#https란-1)
    - [HTTPS와 SSL](#https와-ssl)
    - [SSL과 TLS](#ssl과-tls)
    - [SSL 디지털 인증서](#ssl-디지털-인증서)
    - [SSL에서 사용하는 암호화의 종류](#ssl에서-사용하는-암호화의-종류)
        - [대칭키](#대칭키)
        - [공개키(비대칭키)](#공개키비대칭키)
    - [CA](#ca)
    - [SSL인증서가 서비스를 보장하는 방법](#ssl인증서가-서비스를-보장하는-방법)
    - [SSL의 동작 방법](#ssl의-동작-방법)
        - [HandShake](#handshake)
        - [세션](#세션)
        - [세션 종료](#세션-종료)
        - [정리](#정리)
    - [참고](#참고)

<!-- /TOC -->

## HTTP란
HTTP는 Hypertext Transfer Protocol의 약자다. 즉 Hypertext인 HTML을 전송하기 위한 통신규약을 의미한다. HTTP는 암호화되지 않은 방법으로 데이터를 전송하기 때문에 서버와 클라이언트가 주고받는 메시지를 감청하는 것이 매우 쉽다. 예를 들어 로그인을 위해서 서버로 비밀번호를 전송하거나, 또는 중요한 기밀문서를 열람하는 과정에서 악의적인 감청이나 데이터의 변조 등이 일어날 수 있다는 것이다.

## HTTPS란
이를 보안한 것이 HTTPS다. 여기에서 뒤에 S는 Over Secure Socket Layer(SSL)의 약자로 Secure라는 말을 통해서 알 수 있듯이 보안이 강화된 HTTP라는 것을 알 수 있다. HTTPS는 기본적으로 데이터를 암호화해서 통신을 한다. SSL은 표현 계층의 프로토콜로 응용 계층 아래에 있기 때문에, 어떤 응용 계층의 데이터라도 암호화해서 보낼 수 있다.


## HTTPS와 SSL
HTTPS와 SSL를 같은 의미로 이해하고 있는 경우가 많다. 이것은 맞기도 틀리기도 하다. 그것은 마치 인터넷과 웹을 같은 의미로 이해하는 것과 같다. 결론적으로 말하면 웹이 인터넷 위에서 돌아가는 서비스 중의 하나인 것처럼 HTTPS도 SSL 프로토콜 위에서 돌아가는 프로토콜이다.

## SSL과 TLS
같은 말이다. 네스케이프에 의해서 SSL이 발명되었고, 이것이 점차 폭넓게 사용되다가 표준화 기구인 IETF의 관리로 변경되면서 TLS라는 이름으로 바뀌었다. TLS 1.0은 SSL 3.0을 계승한다. 하지만 TLS라는 이름보다 SSL이라는 이름이 훨씬 많이 사용되고 있다.

## SSL 디지털 인증서
SSL 인증서는 클라이언트와 서버간의 통신을 제3자가 보증해주는 전자화된 문서다. 클라이언트가 서버에 접속한 직후에 서버는 클라이언트에게 이 인증서 정보를 전달한다. 클라이언트는 이 인증서 정보가 신뢰할 수 있는 것인지를 검증 한 후에 다음 절차를 수행하게 된다. SSL과 SSL 디지털 인증서를 이용했을 때의 이점은 아래와 같다.

* 통신 내용이 공격자에게 노출되는 것을 막을 수 있다. 
* 클라이언트가 접속하려는 서버가 신뢰 할 수 있는 서버인지를 판단할 수 있다.
* 통신 내용의 악의적인 변경을 방지할 수 있다. 
* SSL 통신에 사용할 공개키를 클라이언트에게 제공한다.

## SSL에서 사용하는 암호화의 종류 
SSL의 핵심은 암호화다. SSL은 보안과 성능상의 이유로 두 가지 암호화 기법을 혼용해서 사용하고 있는데 SSL 동작방법을 이해하기 위해서는 이 암호화 기법들에 대한 이해가 필요하다.

### 대칭키
암호화는 복호화될 수 있는 것을 말한다. **단방향으로 암호화되는 것을 해쉬화라고 하는데 이 해시는 복호화할 수 없는 값을 말한다.** 그렇기 때문에 해시는 암호화가 아니다. 이 암호화는 대칭키와 비대칭키(공개키)로 나눌 수 있다. 여기에서 대칭키는 동일한 키로 암호화와 복호화를 같이 하는것을 말한다. 즉 암호화키를 wan으로 했으면 복호화도 wan의 키값으로할 수 있는 것을 대칭키 방식이라 한다.


### 공개키(비대칭키)
**공개키 방식은 두개의 키를 갖게 되는데 A키로 암호화를 하면 B키로 복호화 할 수 있고, B키로 암호화하면 A키로 복호화 할 수 있는 방식이다.** 이 방식에 착안해서 두개의 키 중 하나를 비공개키(private key, 개인키, 비밀키라고도 부른다)로하고, 나머지를 공개키(public key)로 지정한다. 비공개키는 자신만이 가지고 있고, 공개키를 타인에게 제공한다. 공개키를 제공 받은 타인은 공개키를 이용해서 정보를 암호화한다. 암호화한 정보를 비공개키를 가지고 있는 사람에게 전송한다. 비공개키의 소유자는 이 키를 이용해서 암호화된 정보를 복호화 한다. 이 과정에서 공개키가 유출된다고해도 비공개키를 모르면 정보를 복호화 할 수 없기 때문에 안전하다. 공개키로는 암호화는 할 수 있지만 복호화는 할 수 없기 때문이다.


## CA
인증서의 역할은 클라이언트가 접속한 서버가 클라이언트가 의도한 서버가 맞는지를 보장하는 역할을 한다. 이 역할을 하는 민간기업들이 있는데 이런 기업들을 CA(Certificate authority) 혹은 Root Certificate 라고 부른다. CA는 아무 기업이나 할 수 있는 것이 아니고 신뢰성이 엄격하게 공인된 기업들만이 참여할 수 있다. 


## SSL인증서가 서비스를 보장하는 방법
웹 브라우저가 서버에 접속할 때 서버는 제일 먼저 인증서를 제공한다. 브라우저는 이 인증서를 발급한 CA가 자신이 내장한 CA의 리스트에 있는지를 확인한다. 확인 결과 서버를 통해서 다운받은 인증서가 내장된 CA 리스트에 포함되어 있다면 해당 CA의 공개키를 이용해서 인증서를 복호화 한다. 


## SSL의 동작 방법
**결론부터 말하면 SSL은 암호화된 데이터를 전송하기 위해서 공개키와 대칭키를 혼합해서 사용한다.** 
* 클라이언트와 서버가 주고 받는 실제 정보는 대칭키 방식으로 암호화를한다
* 대칭키 방식으로 암호화된 실제 정보를 복호화할 때사용할 대칭키는 공개키 방식으로 암호화해서 클라이언트와 서버가 주고 받는다.

위에 내용에 세부적으로 알아보기 이전에 먼저 간단하게 네트워크 통신이 어떻게 이루어지는지 알아보자. 컴퓨터와 컴퓨터가 네트워크를 이용해서 통신을 할 때는 내부적으로 3가지 단계가 있다. 아래와 같다.
```
악수(3way HandShake) -> 전송 -> 세션종료(4way HandShake)
```

이 설명만으로는 https가 어떻게 동작하는지 이해하기 어려울 것이다. 어떠한 과정 속에 인증서를 인증하고 데이터를 넘기는지 알아 볼 것이다. 위의의 관계만 일단 머릿속에 기억해두고 좀 더 구체적인 설명으로 넘어가자.

### HandShake

사람과 사람이 소통을 할 때를 생각해보자. 우선 인사를 한다. 인사를 통해서 상대의 기분과 상황을 상호탐색을 하는 것이다. 이 과정이 잘되야 소통이 원활해진다. 클라이언트와 서버 사이도 마찬가지다. 실제 데이터를 주고 받기 전에 클라이언트와 서버는 일종의 인사인 Handshake(진짜로 사용하는 기술용어다)를 한다. 이 과정을 통해서 서로 상대방이 존재하는지, 또 상대방과 데이터를 주고 받기 위해서는 어떤 방법을 사용해야하는지를 파악한다.

SSL 방식을 이용해서 통신을 하는 브라우저와 서버 역시 핸드쉐이크를 하는데, 이 때 SSL 인증서를 주고 받는다. 

이러한 과정을 정리하면 아래와 같다.

1. 클라이언트가 서버에 접속한다. 이 단계를 Client Hello라고 한다. 이 단계에서 주고 받는 정보는 아래와 같다.
* 클라이언트 측에서 생성한 랜덤 데이터 : 아래 3번 과정 참조
* 클라이언트가 지원하는 암호화 방식들 : 클라이언트와 서버가 지원하는 암호화 방식이 서로 다를 수 있기 때문에 상호간에 어떤 암호화 방식을 사용할 것인지에 대한 협상을 해야 한다. 이 협상을 위해서 클라이언트 측에서는 자신이 사용할 수 있는 암호화 방식을 전송한다.
* 세션 아이디 : 이미 SSL 핸드쉐이킹을 했다면 비용과 시간을 절약하기 위해서 기존의 세션을 재활용하게 되는데 이 때 사용할 연결에 대한 식별자를 서버 측으로 전송한다.
 
2. 서버는 Client Hello에 대한 응답으로 Server Hello를 하게 된다. 이 단계에서 주고 받는 정보는 아래와 같다.
* 서버 측에서 생성한 랜덤 데이터 : 아래 3번 과정 참조
* 서버가 선택한 클라이언트의 암호화 방식 : 클라이언트가 전달한 암호화 방식 중에서 서버 쪽에서도 사용할 수 있는 암호화 방식을 선택해서 클라이언트로 전달한다. 이로써 암호화 방식에 대한 협상이 종료되고 서버와 클라이언트는 이 암호화 방식을 이용해서 정보를 교환하게 된다.

 
3. 클라이언트는 서버의 인증서가 CA에 의해서 발급된 것인지를 확인하기 위해서 클라이언트에 내장된 CA 리스트를 확인한다. CA 리스트에 인증서가 없다면 사용자에게 경고 메시지를 출력한다. 인증서가 CA에 의해서 발급된 것인지를 확인하기 위해서 클라이언트에 내장된 CA의 공개키를 이용해서 인증서를 복호화한다. 복호화에 성공했다면 인증서는 CA의 개인키로 암호화된 문서임이 암시적으로 보증된 것이다. 인증서를 전송한 서버를 믿을 수 있게 된 것이다.

    클라이언트는 상기 2번을 통해서 받은 서버의 랜덤 데이터와 클라이언트가 생성한 랜덤 데이터를 조합해서 pre master secret라는 키를 생성한다. 이 키는 뒤에서 살펴볼 세션 단계에서 데이터를 주고 받을 때 암호화하기 위해서 사용될 것이다. **이 때 사용할 암호화 기법은 대칭키이기 때문에 pre master secret 값은 제 3자에게 절대로 노출되어서는 안된다.**

    그럼 문제는 이 pre master secret 값을 어떻게 서버에게 전달할 것인가이다. 이 때 사용하는 방법이 바로 공개키 방식이다. 서버의 공개키로 pre master secret 값을 암호화해서 서버로 전송하면 서버는 자신의 비공개키로 안전하게 복호화 할 수 있다. 공개키는 서버로부터 받은 인증서 안에 들어있다. 이 서버의 공개키를 이용해서 pre master secret 값을 암호화한 후에 서버로 전송하면 안전하게 전송할 수 있다.
 
4. 서버는 클라이언트가 전송한 pre master secret 값을 자신의 비공개키로 복호화한다. 이로서 서버와 클라이언트가 모두 pre master secret 값을 공유하게 되었다. 그리고 서버와 클라이언트는 모두 일련의 과정을 거쳐서 pre master secret 값을 master secret 값으로 만든다. master secret는 session key를 생성하는데 이 session key 값을 이용해서 서버와 클라이언트는 데이터를 대칭키 방식으로 암호화 한 후에 주고 받는다. 이렇게해서 세션키를 클라이언트와 서버가 모두 공유하게 되었다는 점을 기억해야한다.
 
5. 클라이언트와 서버는 핸드쉐이크 단계의 종료를 서로에게 알린다.



### 세션
세션은 실제로 서버와 클라이언트가 데이터를 주고 받는 단계이다. 이 단계에서 핵심은 정보를 상대방에게 전송하기 전에 session key 값을 이용해서 대칭키 방식으로 암호화 한다는 점이다. 암호화된 정보는 상대방에게 전송될 것이고, 상대방도 세션키 값을 알고 있기 때문에 암호를 복호화 할 수 있다.


### 세션 종료
데이터의 전송이 끝나면 SSL 통신이 끝났음을 서로에게 알려준다. 이 때 통신에서 사용한 대칭키인 세션키를 폐기한다.




### 정리

위에 내용을 좀더 쉽게 설명하는 그림이 있어서 첨부했다.

![](https://i.imgur.com/KYgfDFo.png)


1. 해당사이트는  CA에 인증서를 발급요청한다
2. CA로부터 검토를 인증기관의 개인키로 암호화하여 사이트 인증서 제작
3. 서버로 인증서 발급
4. 인증브라우저에게 인증기관의 공개키를 제공
5. 브라우저가 서버에 접속 요청.
6. 서버는 CA로부터 발급받은 인증서를 브라우저에게 전달
7. 인증기관의 개인키로 서버로 부터 받은 인증서 해독하여 서버 공개키 획득
8. 브라우저는 서버로부터 받은공개키로 대칭키를 암호화하여 서버로 전송
9. 서버는 개인키로 브라우저로부터받은 정보 해독후 대칭키를 얻는다
10. 대칭키를 이용하여 통신함.


## 참고

[생활코딩](https://opentutorials.org/course/228/4894)