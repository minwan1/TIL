# 데이터베이스와 아키텍처 구성

데이터베이스에 관한 아키텍처 역사는 구체적으로 다음 3단계로 나누어서 파악가능
1. Stand-alone
2. 클라이언트 / 서버
3. Web 3계층

**Stand-alone**
이뜻은 혼자라는 의미로 데이터베이스 LAN이나 인터넷등의 네트워크에 접속하지 않고 '독립되어' 동작하는 구성을 말한다. 이것은 네트워크가 아닌 DB서버가 설치된곳에서 데이터베이스를 접근하지않으면 안되니까 불편하다는 단점이 있다.



## 가용성과 확장성의 확보
시스템 다운은 하드웨어 장애, 애플레키엿ㄴ 버그, 운영중에 오류를 놓친 사람의 문제등 시스템장애가 일어나는 원인은 다양하고 복잡하다.  이렇기 떄문에 아키텍처 설계에서 견고한 시스템을 만들기 위해 가장 중요한점은 가용성이다.

### 가용성을 높이는 전략


#### 클러스터란
동일한 기능의 컴포넌트를 병렬화 하는것을 클러스터링이라고 부른다. 동일한 기능의 컴포넌트를 복수개 준비해 한개의 기능을 실현한다의 의미로 사용된다. 
클러스터 구성으로 시스템의 가동률을 높이는 것을 '여유도를 확보한다' 또는 '다중화'라고 ㅏㅎㅂ니다.

## DB서버의 다중화 - 클러스터링

### DB서버의 다중화
DB서버는 다중화에서 특유의 어려운 문제점을 가지고 있다. 간단히 병렬화해서 대수를 증가시키는 웹 서버나 애플리케이션 서버와 비교하면 다중화에 대해 고민 해야 할 부분이 많다. 그 이유는 DB서버가 데이터를 보존하는 '영속 계층' 이기 때문이다.

### DB 와 다른 서버의 차이
데이터베이스는 데이터를 장기간 보존하는 저장소가 필요하다. 이것이 기본적으로 데이터를 일시적으로 처리할뿐인 웹서버와 다른점이다. 웹서버는 데이터를 따로 저장할필요없이 연산만 수행하면 됩니다. 그래서 데이터를 유지하는것에대해 그다지 신경쓸필요가 없다.

하지만 데이터베이스는 대량의 데이터를 영구적으로 보존해야하고 각각 다른 서버에대해 데이터를 처리할 때 정합성등을 보장해줘야한다. 결국 DB서버의 아키텍처는 저장소와 묶어서 생각해야한다.
**데이터베이스는 서버와 저장소로 구성되어진다.**
이건 얼필 보면 아무 문제도 없어보인다. 하지만 DB서버는 영속 계층의 사명이 부여되어 다중화 문제를 결정적으로 어렵게 하고 있다. 특히 데이터는 항상 갱신되기 때문에 다중화를 유지하는 중에 '데이터의 정합성' 문제를 해결하기 어렵다.

#### 가장 기본적인 다중화
가장 간단한 다중화 구성을 생각해보면 DB서버만을 다중화 하고 저장소는 하나만 두는 구성이다. 이경우 데이터가 보존 되는 저장소가 1개라서 정합성을 신경 쓸 필요가 없다. 이 구조는 데이터베이스가 저장소를 제대로 관리하고 있다.

![](https://i.imgur.com/sMrYsPt.png)

위에 그림을 보면 DB서버가 2대 있지만 이 2대가 동시에 동작하는것을 허락할지에 따라 **'Active-Active'** 와 **'Active-StandBy'** 로 나뉜다. 이둘의 차이는 다음과 같다.

* Active-Active 클러스터를 구성하는 컴포넌트를 동시에 가동한다.
* Active-StandBy 클러스터를 구성하는 컴포넌트 중 실제 가동하는 것은 Active, 남은것은 대기(Standby) 하고 있는다.

저장소를 공유한 Active-Active 구성이 가능한 DBMS는 현재 **Oracle과 DB2뿐**이다. Oracle은 'RAC(Real Application Clusters'), DB2는 'pureScale'이라는 이름의 Active-Active 클러스터링이 가능하고, **다른 DBMS에서는 Active-Standby 클러스터링만 대응하고 있다.**

#### Active-Active
Active-Active 클러스터를 구성하는 컴포넌트를 동시에 가동한다. Active-Active 구성은 2가지 장점이 있다

![](https://i.imgur.com/BcNPLEg.png)
1. 시스템 다운 시간이 짧다는 점이다. Active-Active의 경우 복수의 DB서버가 동시에 동작하고 있어서 한대가 다운되어 동작 불능이 되어 동작 불능이 되도 남은 서버가 처리를 계속해 시스템 전체가 정지하는것을 방지할 수 있다.

2. 성능이 좋다. DB 서버 대수가 동시에 가동하는 CPU나 메모리도 증가하기 때문에 성능도 향상 될 수 있다. 단 저장소가 병목이 되기 때문에 생각한 만큼 성능이 향상되지 않는 경우도 있다.


#### Active-Standby
Active-Standby 구성에서는 보통 Standby 상태의 DB 서버는 사용되지 않다가 Active DB서버에서 장애가 일어날 때만 사용된다. 이때문에 전환될때까지 시차가 생기고 그 사이 시스템은 서비스를 계속하는것이 불가능한상태 즉 **다운상태** 가 된다.

![](https://i.imgur.com/NDyM7xg.png)

>Hearbeat
Active-Syandby 구성에서 장애가 일어났을 때 Standby DB서버가 장애가난것을 알기위해 일정간격으로 Standby서버에게 이상이 없는지를 조사하기 위해 헬스체크를 한다. 만약 Active DB서버에 장애가 발생하면 이신호는 응답이 없을것이다.


**Active-Standby 구성의 종류**

Active-Standby 구성은 다시 'Cold-Standby' 와 'Host-Standby'로 구분된다.
* Cold-StandBy 평소에는 Standby DB가 작동하지 않다가 Active DB가 다운된 시점에 작동하는 구성이다.
* Hot-standby 평소에도 Standby DB가 작동하는 구성이다.

Hot-Standby 쪽이 전환 시간은 짧지만, 그만큼 라이선스료가 높게 설정되어 있다. 항상 2대의 DB서버를 사용하지만, 실제로 작동하는것은 Active DB 1대뿐이기 때문에 전환시간을 줄이기 위해 라이선스료를 많이 지급한다는 점에서 Hot-Standby는 매우 사치스러운 구성이라고할 수 있다.(그래도 Active-Active와 비교하면 싸다.)

## DB 서버와 데이터의 다중화

### 리플리케이션이란
앞에서 설명한 Active-Active와 Active-Standby 클러스터 구성에서는 **서버 분은 다중화할 수 있어도 저장소 부분은 다중화할 수 없어서 데이터를 다중화하지 않는 공통적인 단점이 있다.** 즉 저장소가 부서질 경우에는 데이터를 잃게 된다. 그리도 또한 저장소 병목이 되는경우가 있을 수 있다.

만약 데이터 센터 전체가 지진으로 붕괴하거나 화재가 난다면 데이터 저장소가 한개라면 모든 데이터를 잃게 된다. 이런 상황을 대응하기위해 **리플리케이션**이 있다. 이는 DB서버와 저장소 세트를 복수로 준비하는것을 말한다.

![](https://i.imgur.com/s9mSyNi.png)

**리플리케이션 주의**
리플리케이션은 Ative db를 항상 Stadby로 동기화 시켜줘야한다. 하지만 이 동기화 시점을 어느정도의 기간으로 해주느냐에따라 Active 손실에 따라 그기간 만큼 손실이 일어날 수 있다. 그렇다고 해서 이시간을 짧게 해준다면 성능상에서 문제를 가질 수 있다. 즉 트레이드 오프의 관계를 가진다. 
또한 리플리케이션 구성은 원칙적으로 차례로 손자나 증손자 세트를 만들 수 있다. 그형태를 따서 이런 구성을 '파라미드형'이라고 부른다. 

> 부모는 주인 , 아들은 노예
> MySQL에서는 동기화하는 측의 부모(Active) 데이터베이스를 '마스터', 동기화되는 측의 자식 (Standby)데이터베이스를 '슬레이브' 라고 부른다.  이렇게 부르는 것은 MySQL에 한정되지 않고 리플리케이션에서는 매우 일반적으로 사용되는데, 이 마스터와 슬레이브에 따른 리플리케이션을 '마스터 슬레이브 방식'이라고 부른다. 
> 
> 이러한 명칭은 쌍방향 리플리케이션 구조도 있기 때문이다.(이는 '멀티 마스터 방식'으로 부른다.) 하지만 매우 복잡한 구성이라 주변에 보기 어렵다. 거의 마스터슬레이브 방식이라고 생각해도 된다.



## 성능을 추가하기 위한 다중화 - Shared Nothing
### Shared Disk와 Shared Nothing
Active-Active 구성의 DB는 저장소 부분이 병목되는 경우가 있다. 이것은 복수의 서버가 1대의 디스크를 공유하도록 구성되었기 때문에 일어나는 문제이다. 이렇게 복수의 서버가 1대의 디
스크를 사용하는 구성을 **'Shared Disk'** 라고 부른다.

Shared Disk 타입은 Active-Active구성은 DB 서버를 늘려도 무한으로 처리율만 오를뿐 데이터를 결국 데이터를 저장하거나 읽어올 때 병목현상등의 한계점에 도달할 수 있다. 이것은 저장소가 공유 자원이라서 쉽게 늘리기 어렵고 DB 서버 대수가 증가할수록 DB서버간의 정보공유를 위한 오버헤드가 크기 떄문이다. 이단점을 극복하기위해 고안된것이 **Shared Nothing** 이다.

**Shared Nothing**
Shared Nothing은 문자 그대로 '아무것도 공유하지 않는다.'란 의미로 네트워크 이외의 자원을 두 분리하는(아무것도 공유하지) 방식이다. 이 아키텍처는 서버와 저장소의 세트를 늘리면 병렬처리 때문에 선형적으로 성능이 향상되는 장점이 있다. 

![](https://i.imgur.com/yqJiJoL.png)

Shared Nothing 은 위 그림처럼 DB서버와 저장소의 세트를 늘려서 저장소가 병목이 되는것을 방지하고 있어서 이 세트에 비례해서 처리율이 증가한다는 이점을 얻는다.



다음은 데이터베이스의 아키텍처 패턴 그림이다.
![](https://i.imgur.com/0oPz9bH.png)


참고
* [데이터베이스 첫걸음](http://www.hanbit.co.kr/store/books/look.php?p_code=B5934047828)