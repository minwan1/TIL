# 프로세스 관리
## 1. 프로세스의 개념
프로세스란 수행중인 프로그램을 뜻한다. 디스크에 실행 파일 형태로 존재하던 프로그램이 메모리에 올라가서 수행되기 시작하면 비로소 생명력을 갖는 프로세스가 되며, 프로세스는 CPU를 획득해 자신의 코드를 수행하기도 하고, 때로는 CPU를 반환하고 입출력 작업을 수행하기도 한다. 

프로세스를 이해하기위해서는 프로세스의 문맥을 알아야한다. 프로세스문맥란 현재 프로세스가 어떤 상태인지를 정확히 규명하기 위해 필요한 정보를 말한다. 여러개의 프로세스는 시분할 시스템 환경에서 타이머 인터럽트에 의해 짧은 시간동안 CPU를 사용한 후 CPU를 선점당했다가 추후에 다시 CPU를 획득하는 방식으로 CPU관리가 이루어진다.

따라서 CPU를 다시 획득해 명령의 수행을 재개하는 시점이 되면 지난 번 CPU보유 시기에 어느 부분까지 명령을 수행했는지 직접수행 시점의 정확한 상태 정보를 표현하는 프로세스 문맥이 필요하다. 

여기에서 말하는 **프로세스 문맥**이란 프로세스의주소 공간(코드, 데이터, 스택상태)을 비롯해 레지스터에 어떤값을 가지고 있었는지등을 통해 커널에서 수행한 일의 상태, 프로세스에 관해 커널이 관리하고있는 정보(PCB)등을 포함한다.

프로세스 문맥은 크게 아래와같이 3개로 나눌 수 있다.
하드웨어 문맥 : 프로그램 카운터값과 각종 레지스터에 저장하고 있는 값들
프로세의 주소공간 : 코드, 데이터, 스택으로 구성되는 자기 자신만의 독자적인 주소공간을 가지고 있다.
커널상의 문맥 : PCB와 커널스택이 이에 해당한다.

## 2. 프로세스의 상태
프로세스의 상태는 실행, 준비, 봉쇄의 세가지로 구분할 수 있다. 실행 상태는 프로세스가 CPU를 보유하고 기계어를 명령을 실행하고 있는 상태를 가리킨다. 일반적인 컴퓨터 시스템 내에 CPU는 하나 뿐이므로 여러 프로세스가 동시에 실행된다고 해도 실제로 실행 상태에 있는 프로세스는 매시점 하나뿐이다.

다음은 프로세스의 상태변화도를 나타낸것이다.
![프로세스의상태변화도](/assets/프로세스의상태변화도.jpg)

|상태|설명|
|-|-|
|시작 상태 |프로세스가 생성중인 상태. |
|준비 상태 |프로세스가 CPU를 보유하면 당장 명령을 실행할 수 있지만 현재 CPU를 할당받지 못한 상태를 가리킨다. |
|봉쇄 상태  |프로세스에게 CPU를 주어도 당장 명령을 실행할 수 없는 상태를 말한다. (대표적으로는 동기 IO에서 IO를 할때 CPU를 할당해줘도 해당 프로세스가 아무것도 할 수 없는 상태 즉 봉쇄 상태 이기 때문에 CPU를 할당을 안하는데 이 때 프로세스 상태를 봉쇄상태라고한다.) |
|실행 상태 | 프로세스가 CPU를 할당받어 명령어를 실행중인 상태. |
|완료 상태 |프로세스가 종료중인 상태.|

간단하게 상태변화에대해설명한 내용이다.

* 하드디스크에 있는 명령어 코드를 메인메모리에 적재시키면 프로세스는 준비 상태가 된다.
* 준비상태에서 CPU를 할당받으면 실행상태가된다.(스케줄러 디스패치라고한다.)
* 실행 상태에서 타이머 인터럽트등이 발생하면 다시 준비상태가 된다.
* 실행 상태에서 IO등이 일어나게되면 봉쇄상태(waiting)가 된다.

위와 도표와 같이 실행 시킬 프로세스를 변경하기 위해 커널에 PCB(현재실행중인 프로세스로 복귀하기 위한 정보들)에 컨텍스트 문맥을 저장하고 새로운 프로세스의 문맥을 세팅하는 과정을 **문맥 교환(Context Switch)**이라고한다.

준비 상태에 있는 프로세스들으 중에서 CPU를 할당 받을 프로세스를 선택한 후 실제로 CPU의 제어권을 넘겨받는 과정을 **CPU 디스패치**라고한다. 

### 프로세스 제어 블록(PCB)
프로세스 제어 블록(PCB : process Control Block)이란 운영 체제가 시스템 내의 프로세스들을 관리하기 위해 프로세스당 유지하는 정보들을 담는 커널 내의 자료 구조를 뜻한다. 다음과 같은 구성요소를 갖는다
* 프로세스의 상태
* 프로그램 카운터 값
* CPU 레지스터!
* CPU 스케줄링 정보
* 메모리 관리 정보
* 지원 사용 정보
* 입출력 상태 정보


아래는 PCB제어블록에 구성도이다.
![pcb제어블록](/assets/pcb제어블록.jpg)

1. OS가 관리상 사용하느 정보.
-process state, process number
-scheduling information, priority

1. CPU 수행 관련 화드웨어 값
-program counter, registers
3. 메모리 관련
-code, data stack의 위치 정보
4. 파일 관련
-open file descriptors

프로세스의 상태 : CPU를 할당해도 되는지 여부를 결정하기 위해 필요하다.
프로그램 카운터 : 다음에 수행할 명령의 위치를 가리킨다.
CPU 레지스터 : CPU 연산을 위해 현 시점에 레지스터에 어떤값을 저장하고 있는지를 나타낸다.

### 문맥 교환(Context switch)
하나의 사용자 프로세스로부터 다른 사용자 프로세스로 CPU의 제어권이 이양되는 과정을 뜻한다. 문맥교환이 일어나느 과정은 다음과 같다.
1. 사용자 프로세스가 CPU를 할당받고 실행되던중에 타이머 인터럽트가 발생하면 CPU의 제어권은 운영체제에게 넘어가게된다.
2. 그러면 운영체제는 타이머 인터럽트 처리 루틴으로 가서 직전까지 수행중이던 프로세스의 문맥을 저장하고 새롭게 실행 시킬 프로세스에게 CPU를 이양하게 된다.

**문맥교환시 참고사항**
* 타이머 인터럽트가 발생하거나 프로세스가 입출력 요청 시스템콜을 하여 봉쇄상태에 들어가는 경우에는 문맥교환이 일어나지만, 그 밖의 인터럽트나 시스템콜 발생시에는 문맥교환이 일어나지않고 모드변경만이 있을 뿐이다. 문맥교환에 소요되는 시간은 시스템 입장에서 볼 때 일종의 오버헤드이기 때문에 timer인터럽트 시간을 적절하게 설정을 해야한다. 그래야 많은 문맥교환을 피할 수 있다. 그 반대로 CPU 할당시간을너무 크게 설정하면 시분할 시스템의 의미가 퇴색 된다.

다음은 문맥교환이 일어나는 경우와 그렇지 않은 경우를 보여주는 그림이다.
* ![문맥교환이일어나는경우와그렇지않은예](/assets/문맥교환이일어나는경우와그렇지않은예.jpg)

 
### 프로세스를 스케줄링하기위한 큐
프로세스를 스케줄링하기 위한 큐에는 작업큐(job queue), 준비큐(ready queue), 장치큐(device queue)등이 있다.

작업큐 : 시스템내 의 모든 프로세스를 관리하기 위한 큐로 프로세스의 상태와 무관하게 현재 시스템내에 있는 모든 프로세스가 작업 큐에 속한다.
준비큐 : CPU를 할당받고 실행되기 위해 기다리고 있는 프로세스의 집합을 말한다.
장치큐 : 봉쇄상태에 있는 프로세들이 이 큐에 속한다. 봉쇄상태에 있다가 해당장치의 서비스를 받고나서 장치컨트롤러가 인터럽트를 발생시키면 준비상태로 바뀌어 준비큐로 이동한다.

작업큐가 가장 넓은 개념이고 준비큐와 장치큐에 있는 프로세스들은 모두 작업 큐에 속해 있다.

### 스케줄러
스케줄러란 어떤 프로세스에게 자원을 할당할지를 결정하는 운영체제 커널의 모듈을 지칭한다. 스케줄러에는 장기 스케줄러와 단기 스케줄러가 있다.

장기 스케줄러 : 어떤 프로세스를 준비큐에 삽입할지를 결정하는 역할을한다. 처음 프로세스가 생성되면 시작 상태를 거쳐 준비 상태에 이르게 되는데 장기 스케줄러는 시작상태의 프로세스들 중 어떠한 프로세스를 준비 큐에 삽입할 것인지를 결정하는 역할을한다.
단기 스케줄러 : CPU스케줄러라고한다. 준비 상태의 프로세스중에서 어떤 프로세스를 다음번에 CPU를 할당하여 프로세스를 실행 상태로 만들것인지를 결정한다. 시분할 시스템에서는 타이머 인터럽트가 발생하면 단기 스케줄러가 호출된다.

단기스케줄러는 밀리세컨드 이하의 시간 단위로 매우 빈번하게 호출되기 때문에 수행속도가 빨라야한다. 잔면 장기스케줄러는 수십초에서 수분단위로 가끔 호출되기 때문에 상대적으로 속도가 느린것이 허용된다. 







